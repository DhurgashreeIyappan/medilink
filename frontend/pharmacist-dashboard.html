<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pharmacist Dashboard - MediLink</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

  <nav class="navbar navbar-dark bg-success">
    <div class="container">
      <a class="navbar-brand" href="#">MediLink Pharmacist</a>
      <a class="btn btn-light" href="login.html">Logout</a>
    </div>
  </nav>

  <div class="container mt-5">
    <h2 class="text-success">Welcome, Pharmacist</h2>
    <p class="lead">Manage your inventory and fulfill prescriptions here.</p>

     <!-- Orders Section -->
    <div id="orders-section" class="mt-5">
      <h4 class="text-primary mb-4">Customer Orders</h4>
      <div id="orders-list" class="row">
        <!-- Orders will be inserted here by JavaScript -->
      </div>
    </div>
  </div>

  <script>
  async function fetchOrders() {
    try {
      const token = localStorage.getItem('token');  // assuming token is saved on login
      const response = await fetch('/all-orders', {
        headers: {
          'Authorization': token
        }
      });

      if (!response.ok) {
        throw new Error('Failed to fetch orders');
      }

      const orders = await response.json();
      renderOrders(orders);
    } catch (err) {
      console.error(err);
      alert('Error loading orders.');
    }
  }

  function renderOrders(orders) {
  const container = document.getElementById("orders-list");
  container.innerHTML = "";

  // Filter out orders that are approved or rejected
  const filteredOrders = orders.filter(order => order.status !== 'approved' && order.status !== 'rejected');

  filteredOrders.forEach(order => {
    const col = document.createElement("div");
    col.className = "col-md-4 mb-4";

    col.innerHTML = `
      <div class="card shadow text-center">
        <div class="card-body">
          <h5 class="card-title">Order #${order.order_id}</h5>
          <p class="card-text">Customer: ${order.customer}</p>
          <p class="card-text">Medicine: ${order.medicine}</p>
          <p class="card-text">Quantity: ${order.quantity}</p>
          <p class="card-text">Status: ${order.status || 'Pending'}</p>
          <button class="btn btn-success me-2" onclick="updateOrder(${order.order_id}, 'approved')">Accept</button>
          <button class="btn btn-danger" onclick="updateOrder(${order.order_id}, 'rejected')">Reject</button>
        </div>
      </div>
    `;

    container.appendChild(col);
  });
}


  async function updateOrder(orderId, status) {
    const token = localStorage.getItem('token');

    try {
      const response = await fetch('/update-order', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': token
        },
        body: JSON.stringify({ order_id: orderId, status })
      });

      if (!response.ok) {
        throw new Error('Failed to update order');
      }

      alert(`Order #${orderId} ${status.toLowerCase()} successfully`);
      fetchOrders();  // Refresh the list
    } catch (err) {
      console.error(err);
      alert('Error updating order');
    }
  }

  document.addEventListener("DOMContentLoaded", fetchOrders);
</script>


</body>
</html>
